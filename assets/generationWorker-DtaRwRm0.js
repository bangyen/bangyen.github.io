const T={HINT_DENSITY:0},B=0,g=1,y=2;class S{constructor(n){this.parent=Array.from({length:n},(r,o)=>o)}find(n){const r=this.parent[n];if(r===void 0)throw new Error(`DSU: Index ${String(n)} out of bounds`);r!==n&&(this.parent[n]=this.find(r));const o=this.parent[n];if(o===void 0)throw new Error(`DSU: Parent of ${String(n)} became undefined`);return o}union(n,r){const o=this.find(n),f=this.find(r);return o!==f?(this.parent[o]=f,!0):!1}connected(n,r){return this.find(n)===this.find(r)}}function v(s,n,r){return s*(r+1)+n}function M(s,n,r){const o=Array.from({length:n+1},()=>new Array(r+1).fill(0));for(let f=0;f<n;f++){const l=s[f];if(l)for(let d=0;d<r;d++){const e=l[d];if(e===g){const t=o[f];if(t){const c=t[d+1];c!==void 0&&(t[d+1]=c+1)}const i=o[f+1];if(i){const c=i[d];c!==void 0&&(i[d]=c+1)}}else if(e===y){const t=o[f];if(t){const c=t[d];c!==void 0&&(t[d]=c+1)}const i=o[f+1];if(i){const c=i[d+1];c!==void 0&&(i[d+1]=c+1)}}}}return o}function C(s,n,r,o){const f=M(s,r,o);for(let l=0;l<=r;l++)for(let d=0;d<=o;d++){const e=n[l]?.[d];if(e!=null&&f[l]?.[d]!==e)return!1}return!0}function w(s,n,r,o,f,l){const d=s[r];if(!d)return!1;d[o]=f;const e=f===g?v(r,o+1,l):v(r,o,l),t=f===g?v(r+1,o,l):v(r+1,o+1,l);return n.connected(e,t)?!1:(n.union(e,t),!0)}function D(s,n,r,o,f){let l=!0;for(;l;){l=!1;for(let e=0;e<=r;e++)for(let t=0;t<=o;t++){const i=n[e]?.[t];if(i==null)continue;const c=[{gr:e-1,gc:t-1,pt:y},{gr:e-1,gc:t,pt:g},{gr:e,gc:t-1,pt:g},{gr:e,gc:t,pt:y}].filter(({gr:a,gc:h})=>a>=0&&a<r&&h>=0&&h<o);let u=0;const p=[];for(const a of c){const h=s[a.gr]?.[a.gc];h===B?p.push(a):h===a.pt&&u++}if(u>i||u+p.length<i)return"contradiction";if(u===i&&p.length>0){for(const{gr:a,gc:h,pt:m}of p)if(s[a]?.[h]===B){if(!w(s,f,a,h,m===g?y:g,o))return"contradiction";l=!0}}else if(u+p.length===i&&p.length>0){for(const{gr:a,gc:h,pt:m}of p)if(s[a]?.[h]===B){if(!w(s,f,a,h,m,o))return"contradiction";l=!0}}}if(!l){for(let e=0;e<r;e++)for(let t=0;t<o;t++){const i=s[e];if(i?.[t]!==B)continue;const c=v(e,t+1,o),u=v(e+1,t,o),p=f.connected(c,u),a=v(e,t,o),h=v(e+1,t+1,o),m=f.connected(a,h);if(p&&m)return"contradiction";p?(i[t]=y,l=!0,f.union(a,h)):m&&(i[t]=g,l=!0,f.union(c,u))}if(!l)for(let e=0;e<r;e++)for(let t=0;t<o;t++){if(s[e]?.[t]!==B)continue;let c=!1,u=!1;const p=[{nr:e,nc:t,touchedBy:y},{nr:e,nc:t+1,touchedBy:g},{nr:e+1,nc:t,touchedBy:g},{nr:e+1,nc:t+1,touchedBy:y}];for(const{nr:a,nc:h,touchedBy:m}of p){const A=n[a]?.[h];if(A==null)continue;const E=[{gr:a-1,gc:h-1,pt:y},{gr:a-1,gc:h,pt:g},{gr:a,gc:h-1,pt:g},{gr:a,gc:h,pt:y}].filter(({gr:b,gc:k})=>b>=0&&b<r&&k>=0&&k<o);let N=0,I=0;for(const b of E){const k=s[b.gr]?.[b.gc];k===B?I++:k===b.pt&&N++}m===g?(N+1>A&&(c=!0),N+(I-1)<A&&(u=!0)):(N+1>A&&(u=!0),N+(I-1)<A&&(c=!0))}if(c&&u)return"contradiction";if(c){if(!w(s,f,e,t,y,o))return"contradiction";l=!0}else if(u){if(!w(s,f,e,t,g,o))return"contradiction";l=!0}}}}return s.every(e=>e.every(t=>t!==B))?"solved":"stuck"}function F(s,n,r){const o=Array.from({length:n},()=>new Array(r).fill(B)),f=new S((n+1)*(r+1)),l=D(o,s,n,r,f);return l==="contradiction"||l!=="solved"?!1:C(o,s,n,r)}function R(s,n,r,o){const f=s.map(t=>[...t]),l=[];for(let t=0;t<=n;t++)for(let i=0;i<=r;i++)l.push({r:t,c:i});for(let t=l.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1)),c=l[t],u=l[i];c&&u&&(l[t]=u,l[i]=c)}const d=Math.floor((n+1)*(r+1)*o);let e=0;for(let t=0;t<=n;t++)for(let i=0;i<=r;i++)f[t]?.[i]!==null&&e++;for(const{r:t,c:i}of l){if(e<=d)break;const c=f[t];if(!c)continue;const u=c[i];u!=null&&(c[i]=null,F(f,n,r)?e--:c[i]=u)}return f}function _(s,n){let r=[],o=!1;for(let d=0;d<50&&!o;d++){r=Array.from({length:s},()=>new Array(n).fill(B));const e=new S((s+1)*(n+1)),t=[];for(let c=0;c<s;c++)for(let u=0;u<n;u++)t.push({r:c,c:u});for(let c=t.length-1;c>0;c--){const u=Math.floor(Math.random()*(c+1)),p=t[c],a=t[u];p&&a&&(t[c]=a,t[u]=p)}let i=!1;for(const{r:c,c:u}of t){const p=v(c,u+1,n),a=v(c+1,u,n),h=e.connected(p,a),m=v(c,u,n),A=v(c+1,u+1,n),E=e.connected(m,A);if(h&&E){i=!0;break}const N=r[c];N&&(h?(N[u]=y,e.union(m,A)):E||Math.random()<.5?(N[u]=g,e.union(p,a)):(N[u]=y,e.union(m,A)))}i||(o=!0)}o||(r=Array.from({length:s},(d,e)=>new Array(n).fill(e%2===0?g:y)));const f=M(r,s,n);return{numbers:R(f.map(d=>d.map(e=>e)),s,n,T.HINT_DENSITY),solution:r}}globalThis.onmessage=s=>{if(s.data.type==="GENERATE")try{const{rows:n,cols:r}=s.data.payload,{numbers:o,solution:f}=_(n,r);self.postMessage({type:"RESULT",payload:{rows:n,cols:r,numbers:o,solution:f}})}catch(n){const r=n instanceof Error?n.message:"Unknown worker error";self.postMessage({type:"ERROR",payload:{message:r}})}};
