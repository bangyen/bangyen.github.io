!function(){"use strict";const e=1,t=2;function r(e,t,r){return e*(r+1)+t}self.onmessage=s=>{if("SOLVE"===s.data.type){const{rows:o,cols:c,numbers:n,userMoves:i}=s.data.payload,f=new Map,a=[],u=[];i.forEach((e,t)=>{f.set(t,{state:e,source:"user"});const[r,s]=t.split(",").map(Number);void 0!==r&&void 0!==s&&a.push({r:r,c:s})});const l=(e,t)=>{if(e<0||e>=o||t<0||t>=c)return 0;const r=`${String(e)},${String(t)}`;return f.get(r)?.state??0},d=(e,t,r,s)=>{const o=`${String(e)},${String(t)}`,c=f.get(o);c?c.state!==r&&u.push({type:"cell",r:e,c:t}):(f.set(o,{state:r,source:s}),a.push({r:e,c:t}))},p=(r,s)=>[{r:r-1,c:s-1,required:t},{r:r-1,c:s,required:e},{r:r,c:s-1,required:e},{r:r,c:s,required:t}].filter(e=>e.r>=0&&e.r<o&&e.c>=0&&e.c<c);let g=0;for(;g<a.length;){const r=a[g++];if(!r)break;const{r:s,c:o}=r,c=[{r:s,c:o},{r:s,c:o+1},{r:s+1,c:o},{r:s+1,c:o+1}];for(const i of c){const r=n[i.r]?.[i.c];if(null==r)continue;const c=p(i.r,i.c);let a=0;const g=[];for(const e of c){const t=l(e.r,e.c);0===t?g.push(e):t===e.required&&a++}if(a>r)u.push({type:"node",r:i.r,c:i.c});else if(a+g.length<r)u.push({type:"node",r:i.r,c:i.c});else if("user"===f.get(`${String(s)},${String(o)}`)?.source)if(a===r&&g.length>0)for(const s of g){const r=s.required===e?t:e;d(s.r,s.c,r,"propagated")}else if(a+g.length===r&&g.length>0)for(const e of g)d(e.r,e.c,e.required,"propagated")}}const h=Array.from({length:o},()=>Array(c).fill(0));f.forEach((e,t)=>{const[r,s]=t.split(",").map(Number);void 0!==r&&void 0!==s&&h[r]&&(h[r][s]=e.state)});const S=function(t,s,o){const c=new Map,n=new Set;for(let l=0;l<s;l++)for(let s=0;s<o;s++){const n=t[l]?.[s];if(!n||0===n)continue;const i=r(l,n===e?s+1:s,o),f=r(l+1,n===e?s:s+1,o);c.has(i)||c.set(i,[]),c.has(f)||c.set(f,[]),c.get(i)?.push({node:f,r:l,c:s}),c.get(f)?.push({node:i,r:l,c:s})}const i=new Set,f=new Set,a=[],u=(e,t)=>{i.add(e),f.add(e);const r=c.get(e)??[];for(const{node:s,r:o,c:c}of r)if(s!==t)if(f.has(s)){n.add(`${String(o)},${String(c)}`);for(let e=a.length-1;e>=0;e--){const t=a[e];if(!t)break;if(n.add(`${String(t.r)},${String(t.c)}`),t.u===s||t.v===s)break}}else i.has(s)||(a.push({r:o,c:c,u:e,v:s}),u(s,e),a.pop());f.delete(e)};for(const e of c.keys())i.has(e)||u(e,-1);return n}(h,o,c);self.postMessage({type:"RESULT",payload:{gridState:f,conflicts:u,cycleCells:S}})}}}();
