import{r as e,j as t,a as r}from"./vendor_react-CPTKWKBb.js";import{b as n,B as o,g as s,d as i,I as l,i as c,f as a,h as u,j as d,k as f,S as p,l as h,m as g,o as x,n as m,u as b,q as y,v as S,C as v,t as w,c as C,a as k,p as j,w as E,r as R,G as I,s as T}from"./InfoNavigation-DfU625qQ.js";import{G as O,t as N}from"./PageLayout-e5FkAEPq.js";import{B as M,e as D,M as A,h as z,I as G}from"./vendor_mui_core-D9k3Vigt.js";import{E as H,k as $,l as P,N as B,P as L,f as W,c as _,D as U,M as q}from"./vendor_mui_icons-CTfyhkcx.js";import{S as F,C as V,A as K,e as J,L as X,d as Y}from"./index-SRUj2Se0.js";const Z="130%",Q="6px",ee=100,te=1e3,re=100,ne=.8,oe={...n("slant"),GHOST_MOVES:"slant-ghost-moves"},se=0,ie=8,le=5,ce={COLORS:{WHITE:"#fff"},SHADOWS:{LINE:o.SHADOW,HINT:"0 4px 8px rgba(0,0,0,0.1)"},GHOST:{BORDER:"var(--slant-ghost-border)",BG_SUBTLE:"var(--slant-ghost-bg-subtle)",BG_HOVER:"var(--slant-ghost-bg-hover)",DASHED_BORDER:"var(--slant-ghost-dashed-border)",HINT_BG:"var(--slant-ghost-hint-bg)",HINT_BORDER:"var(--slant-ghost-hint-border)",HINT_TEXT:"var(--slant-ghost-hint-text)"}},ae=1,ue=2,de=[[ue,ae,ue],[ue,ae,ue],[ue,ae,ue]],fe=[[1,0,2,0],[1,2,2,1],[1,2,2,1],[0,2,0,1]],pe=[[0,0],[2,2],[0,2],[2,0],[0,1],[2,1],[1,0],[1,1],[1,2]];function he(e,t,r){const n=Array.from({length:t+1},()=>new Array(r+1).fill(0));for(let o=0;o<t;o++){const t=e[o];if(t)for(let e=0;e<r;e++){const r=t[e];if(r===ae){const t=n[o];if(t){const r=t[e+1];void 0!==r&&(t[e+1]=r+1)}const r=n[o+1];if(r){const t=r[e];void 0!==t&&(r[e]=t+1)}}else if(r===ue){const t=n[o];if(t){const r=t[e];void 0!==r&&(t[e]=r+1)}const r=n[o+1];if(r){const t=r[e+1];void 0!==t&&(r[e+1]=t+1)}}}}return n}function ge(e,t,r,n){const o=new Set,i=he(e,r,n);for(let l=0;l<=r;l++)for(let e=0;e<=n;e++){const r=t[l]?.[e];if(null==r)continue;(i[l]?.[e]??0)===r&&o.add(s(l,e))}return o}function xe(e,t){return{position:"absolute",width:"115%",height:`${String(Math.max(2,t))}px`,backgroundColor:V.text.primary,borderRadius:"99px",top:"50%",left:"50%",transform:`translate(-50%, -50%) rotate(${e})`,boxShadow:ce.SHADOWS.LINE,transition:K.transition,pointerEvents:"none"}}function me({size:r}){const n=e.useMemo(()=>function(){const e=[],t=Array.from({length:3},()=>new Array(3).fill(0));e.push(t);let r=t.map(e=>[...e]);for(const[n,o]of pe){r=r.map(e=>[...e]);const t=de[n]?.[o];if(void 0!==t){const e=r[n];e&&(e[o]=t)}e.push(r)}return e.push(r.map(e=>[...e])),e}(),[]),[o,l]=e.useState(0);e.useEffect(()=>{const e=setInterval(()=>{l(e=>(e+1)%n.length)},1500);return()=>{clearInterval(e)}},[n.length]);const c=e.useMemo(()=>n[o]??n[0]??[],[n,o]),a=o>0&&o<=pe.length?(()=>{const e=pe[o-1];return e?s(e[0],e[1]):null})():null,u=e.useMemo(()=>ge(c,fe,3,3),[c]),d=.4*r,f=o>=pe.length&&c.every(e=>e.every(e=>0!==e)),p=e.useMemo(()=>function(e,r,n){return(o,i)=>{const l=e[o]?.[i],c=s(o,i)===n;return{sx:{border:`1px solid ${V.border.subtle}`,position:"relative",transition:K.transition,...c?{backgroundColor:V.interactive.hover}:{}},children:t.jsxs(M,{sx:{width:"100%",height:"100%",position:"relative"},children:[l===ae&&t.jsx(M,{sx:xe("-45deg",r)}),l===ue&&t.jsx(M,{sx:xe("45deg",r)})]})}}}(c,r,a),[c,r,a]),h=e.useMemo(()=>function(e,r,n){return(o,i)=>{const l=e[o]?.[i],c=s(o,i),a=r.has(c);return{sx:{pointerEvents:"none"},children:t.jsx(M,{sx:{borderRadius:"50%",backgroundColor:V.surface.background,border:null==l?"none":`2px solid ${a?"transparent":V.border.subtle}`,fontSize:`${String(.5*n)}rem`,fontWeight:"800",color:a?V.interactive.disabledText:V.text.primary,boxShadow:a?"none":ce.SHADOWS.HINT,zIndex:5,opacity:null==l?0:1,display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",userSelect:"none",WebkitUserSelect:"none",width:`${String(n)}rem`,height:`${String(n)}rem`},children:l??""})}}}(fe,u,d),[u,d]);return t.jsx(M,{sx:{display:"flex",justifyContent:"center",alignItems:"center",flex:1},children:t.jsxs(M,{sx:{position:"relative",display:"inline-flex"},children:[t.jsx(i,{size:r,rows:4,cols:4,frontProps:h,backProps:p,frontLayerSx:{pointerEvents:"none"}}),t.jsx(M,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",opacity:f?1:0,transform:f?"scale(1)":"scale(0.5)",visibility:f?"visible":"hidden",transition:"all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)",pointerEvents:"none",zIndex:10,backgroundColor:"transparent"},children:t.jsx(O,{padding:F.padding.md,sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:1,height:"auto",width:"auto",maxWidth:"80%"},children:t.jsx(H,{sx:{fontSize:{xs:"2rem",sm:"3rem"},color:V.primary.main,filter:"drop-shadow(0 4px 12px rgba(0,0,0,0.1))"}})})})]})})}function be(){return t.jsx(M,{sx:{flex:1,display:"flex",flexDirection:"column",animation:"fadeIn 0.3s ease"},children:t.jsx(M,{sx:{flex:1,display:"flex",flexDirection:"column",justifyContent:"center"},children:t.jsx(me,{size:5})})})}function ye({onOpenCalculator:e}){return t.jsxs(M,{sx:{animation:"fadeIn 0.3s ease",flex:1,display:"flex",flexDirection:"column"},children:[t.jsxs(M,{sx:{flex:1,display:"flex",flexDirection:"column",justifyContent:"center",gap:4},children:[t.jsx(l,{Icon:$,title:"Fill with Slashes",text:"Place a forward (/) or backward (\\) slash in every cell of the grid."}),t.jsx(l,{Icon:P,title:"Match the Numbers",text:"Each number at a corner tells how many slashes touch that point."}),t.jsx(l,{Icon:B,title:"No Loops",text:"Slashes must never form a closed loop â€” every path stays open."})]}),t.jsx(M,{sx:{display:"flex",px:2,ml:{xs:5,sm:4},pt:{xs:0,sm:3},mt:{xs:-2,sm:0}},children:t.jsx(D,{variant:"outlined",startIcon:t.jsx(L,{}),onClick:e,sx:{borderColor:V.border.subtle,color:V.text.secondary},children:"Open Calculator"})})]})}const Se=O,ve=["Slant Rules","Example"];function we({open:r,toggleOpen:n,onOpenCalculator:o}){const[s,i]=e.useState(0),l=()=>{n()};return t.jsx(A,{open:r,onClose:l,slots:{backdrop:z},slotProps:{backdrop:{sx:a}},sx:c,children:t.jsx(M,{sx:u,children:t.jsxs(Se,{onClick:e=>{e.stopPropagation()},sx:{...d,height:{xs:"660px",sm:"525px"},minHeight:{xs:"660px",sm:"525px"}},children:[t.jsxs(M,{sx:[...N(m(s)),{overflowY:"hidden"}],children:[t.jsxs(M,{sx:f,children:[t.jsx(p,{children:ve[s]}),t.jsx(G,{onClick:l,size:"small",sx:h,children:t.jsx(W,{})})]}),t.jsxs(M,{sx:g(s),children:[0===s&&t.jsx(ye,{onOpenCalculator:o}),1===s&&t.jsx(be,{})]})]}),t.jsx(x,{step:s,totalSteps:2,onBack:()=>{s>0&&i(s-1)},onNext:()=>{s<1?i(s+1):n()}})]})})})}const Ce=r.memo(function({value:e,color:r}){return t.jsxs(M,{sx:{width:"100%",height:"100%",position:"relative"},children:[e===ae&&t.jsx(M,{sx:{position:"absolute",width:Z,height:Q,backgroundColor:r,borderRadius:F.borderRadius.full,top:"50%",left:"50%",transform:"translate(-50%, -50%) rotate(-45deg)",boxShadow:ce.SHADOWS.LINE,transition:K.transition,pointerEvents:"none"}}),e===ue&&t.jsx(M,{sx:{position:"absolute",width:Z,height:Q,backgroundColor:r,borderRadius:F.borderRadius.full,top:"50%",left:"50%",transform:"translate(-50%, -50%) rotate(45deg)",boxShadow:ce.SHADOWS.LINE,transition:K.transition,pointerEvents:"none"}})]})}),ke=({onCopy:e,onClear:r,onClose:n})=>t.jsxs(M,{sx:{display:"flex",justifyContent:"center",gap:2,position:"absolute",bottom:-90,left:0,right:0,pointerEvents:"auto",zIndex:X.zIndex.base+5,paddingBottom:2},children:[t.jsx(J,{title:"Copy Board",Icon:_,onClick:e,sx:{backgroundColor:V.interactive.selected,color:V.primary.main,"&:hover":{backgroundColor:V.interactive.focus}}}),t.jsx(J,{title:"Clear Calculator",Icon:U,onClick:r,sx:{backgroundColor:"rgba(255, 68, 68, 0.1)",color:V.data.red,"&:hover":{backgroundColor:"rgba(255, 68, 68, 0.2)"}}}),t.jsx(J,{title:"Close Calculator",Icon:W,onClick:n,sx:{backgroundColor:"rgba(255, 193, 7, 0.1)",color:V.data.amber,"&:hover":{backgroundColor:"rgba(255, 193, 7, 0.2)"}}})]}),je=r.memo(function({value:e,hasConflict:r,numberSize:n}){return t.jsx(M,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:`${String(.5*n)}rem`,fontWeight:"800",color:r?ce.COLORS.WHITE:ce.GHOST.HINT_TEXT,transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",userSelect:"none",WebkitUserSelect:"none",transform:r?"scale(1.1)":"scale(1)"},children:e??""})});class Ee{constructor(e){this.parent=Array.from({length:e},(e,t)=>t)}find(e){const t=this.parent[e];if(void 0===t)throw new Error(`DSU: Index ${String(e)} out of bounds`);t!==e&&(this.parent[e]=this.find(t));const r=this.parent[e];if(void 0===r)throw new Error(`DSU: Parent of ${String(e)} became undefined`);return r}union(e,t){const r=this.find(e),n=this.find(t);return r!==n&&(this.parent[r]=n,!0)}connected(e,t){return this.find(e)===this.find(t)}}function Re(e,t,r){return e*(r+1)+t}function Ie(e,t,r){const n=new Map,o=new Set;for(let s=0;s<t;s++)for(let t=0;t<r;t++){const o=e[s]?.[t];if(!o||0===o)continue;const i=Re(s,o===ae?t+1:t,r),l=Re(s+1,o===ae?t:t+1,r);n.has(i)||n.set(i,[]),n.has(l)||n.set(l,[]),n.get(i)?.push({node:l,r:s,c:t}),n.get(l)?.push({node:i,r:s,c:t})}const i=new Set,l=new Set,c=[],a=(e,t)=>{i.add(e),l.add(e);const r=n.get(e)??[];for(const{node:n,r:u,c:d}of r)if(n!==t)if(l.has(n)){o.add(s(u,d));for(let e=c.length-1;e>=0;e--){const t=c[e];if(!t)break;if(o.add(s(t.r,t.c)),t.u===n||t.v===n)break}}else i.has(n)||(c.push({r:u,c:d,u:e,v:n}),a(n,e),c.pop());l.delete(e)};for(const s of n.keys())i.has(s)||a(s,-1);return o}const Te=({rows:r,cols:n,numbers:i,size:l,initialMoves:c,onMove:a,onCopy:u,onClear:d,onClose:f})=>{const p=b("sm"),h=c,{getDragProps:g}=y({onToggle:(e,t,r,n,o)=>{const i=s(e,t);if(!o)return void a(i,n);const l=h.get(i);let c;return c=r?l===ae?ue:l===ue?void 0:ae:l===ue?ae:l===ae?void 0:ue,a(i,c),c},touchTimeout:S.timing.touchHoldDelay,checkEnabled:()=>!0}),[x,m]=e.useState(new Map),[w,C]=e.useState([]),[k,j]=e.useState(new Set),E=e.useRef(null),[R,I]=e.useState("probing");e.useEffect(()=>{let e=!1;const t=new Worker(new URL("/assets/solverWorker-Dugk-xAa.js",import.meta.url),{type:"module"});E.current=t;const r=setTimeout(()=>{e||(I("broken"),E.current=null,t.terminate())},2e3);return t.onmessage=t=>{if(e)return;const n=t.data;"RESULT"===n.type&&I(e=>{if("probing"===e)return clearTimeout(r),"healthy";const{gridState:t,conflicts:o,cycleCells:s}=n.payload;return m(t),C(o),j(s),e})},t.onerror=()=>{clearTimeout(r),I("broken"),E.current=null,t.terminate()},t.postMessage({type:"SOLVE",payload:{rows:2,cols:2,numbers:[[null,null,null],[null,null,null],[null,null,null]],userMoves:new Map}}),()=>{e=!0,clearTimeout(r),t.terminate()}},[]),e.useEffect(()=>{if("healthy"===R&&E.current)E.current.postMessage({type:"SOLVE",payload:{rows:r,cols:n,numbers:i,userMoves:h}});else if("broken"===R){const e=function(e,t,r,n){const o=new Map,i=[],l=[];n.forEach((e,t)=>{o.set(t,{state:e,source:"user"});const[r,n]=t.split(",").map(Number);void 0!==r&&void 0!==n&&i.push({r:r,c:n})});const c=(r,n)=>{if(r<0||r>=e||n<0||n>=t)return 0;const i=s(r,n);return o.get(i)?.state??0},a=(e,t,r,n)=>{const c=s(e,t),a=o.get(c);a?a.state!==r&&l.push({type:"cell",r:e,c:t}):(o.set(c,{state:r,source:n}),i.push({r:e,c:t}))},u=(r,n)=>[{r:r-1,c:n-1,required:ue},{r:r-1,c:n,required:ae},{r:r,c:n-1,required:ae},{r:r,c:n,required:ue}].filter(r=>r.r>=0&&r.r<e&&r.c>=0&&r.c<t);let d=0;for(;d<i.length;){const e=i[d++];if(!e)break;const{r:t,c:n}=e,f=[{r:t,c:n},{r:t,c:n+1},{r:t+1,c:n},{r:t+1,c:n+1}];for(const i of f){const e=r[i.r]?.[i.c];if(null==e)continue;const d=u(i.r,i.c);let f=0;const p=[];for(const t of d){const e=c(t.r,t.c);0===e?p.push(t):e===t.required&&f++}if(f>e)l.push({type:"node",r:i.r,c:i.c});else if(f+p.length<e)l.push({type:"node",r:i.r,c:i.c});else if("user"===o.get(s(t,n))?.source)if(f===e&&p.length>0)for(const t of p){const e=t.required===ae?ue:ae;a(t.r,t.c,e,"propagated")}else if(f+p.length===e&&p.length>0)for(const t of p)a(t.r,t.c,t.required,"propagated")}}const f=Array.from({length:e},()=>new Array(t).fill(0));for(const[s,h]of o.entries()){const[e,t]=s.split(",").map(Number);void 0!==e&&void 0!==t&&f[e]&&(f[e][t]=h.state)}const p=Ie(f,e,t);return{gridState:o,conflicts:l,cycleCells:p}}(r,n,i,h);m(e.gridState),C(e.conflicts),j(e.cycleCells)}},[h,i,r,n,R]);const T=.4*l,O=l-T,N=e.useMemo(()=>new Set(w.filter(e=>"cell"===e.type).map(e=>s(e.r,e.c))),[w]),D=e.useMemo(()=>new Set(w.filter(e=>"node"===e.type).map(e=>s(e.r,e.c))),[w]),A=e.useCallback((e,r)=>{const n=s(e,r),o=x.get(n),i=o?.state??0,l=o?.source,c=N.has(n),a=k.has(n),u=g(n);let d=V.text.primary;return c?d=V.data.red:a?d="user"===l?V.data.red:"#ff9800":"user"===l?d=V.primary.main:"propagated"===l&&(d=V.data.green),{...u,"data-pos":n,"data-type":"cell",sx:{...u.sx,cursor:"pointer",border:`1px solid ${ce.GHOST.BORDER}`,position:"relative",backgroundColor:ce.GHOST.BG_SUBTLE,"&:hover":{backgroundColor:ce.GHOST.BG_HOVER}},children:t.jsx(Ce,{value:i,color:d})}},[x,N,k,g]),z=e.useCallback((e,r)=>{const n=i[e]?.[r],o=D.has(s(e,r));return{"data-pos":s(e,r),"data-type":"hint",children:t.jsx(je,{value:n??null,hasConflict:o,numberSize:T}),sx:{borderRadius:"50%",backgroundColor:o?V.data.red:ce.GHOST.HINT_BG,border:null==n?"none":`2px solid ${o?V.data.red:ce.GHOST.HINT_BORDER}`,zIndex:5,opacity:null==n?0:1,position:"relative",pointerEvents:"none"}}},[i,D,T]);return t.jsxs(M,{sx:{position:"relative",userSelect:"none"},children:[t.jsxs(M,{sx:{position:"relative",padding:p?o.PADDING.MOBILE:o.PADDING.DESKTOP,border:`2px dashed ${ce.GHOST.DASHED_BORDER}`,borderRadius:o.BORDER_RADIUS},children:[t.jsx(M,{sx:{position:"relative",zIndex:X.zIndex.base+1},children:t.jsx(v,{size:l,rows:r,cols:n,cellProps:A,space:0,sx:{width:"fit-content"}})}),t.jsx(M,{sx:{position:"absolute",top:p?o.PADDING.MOBILE:o.PADDING.DESKTOP,left:p?o.PADDING.MOBILE:o.PADDING.DESKTOP,transform:`translate(-${String(T/2)}rem, -${String(T/2)}rem)`,zIndex:X.zIndex.base+2,pointerEvents:"none"},children:t.jsx(v,{size:T,rows:r+1,cols:n+1,cellProps:z,space:O,sx:{width:"fit-content"}})})]}),t.jsx(ke,{onCopy:u,onClear:d,onClose:f})]})};function Oe({size:r,rows:n,cols:o}){const s=e.useCallback(()=>({sx:{backgroundColor:"var(--border)"}}),[]),l=e.useCallback(()=>({}),[]);return t.jsx(M,{sx:{"@keyframes pulse":{"0%, 100%":{opacity:.4},"50%":{opacity:.15}},animation:"pulse 1.4s ease-in-out infinite"},children:t.jsx(i,{size:r,rows:n+1,cols:o+1,frontProps:l,backProps:s,frontLayerSx:{pointerEvents:"none"}})})}function Ne({isGhostMode:e,generating:r,dimensionsMismatch:n,rows:o,cols:s,state:l,size:c,ghostMoves:a,onGhostMove:u,onGhostCopy:d,onGhostClear:f,onGhostClose:p,backProps:h,frontProps:g}){return e?t.jsx(Te,{rows:o,cols:s,numbers:l.numbers,size:c,initialMoves:a,onMove:u,onCopy:d,onClear:f,onClose:p}):r||n?t.jsx(Oe,{size:c,rows:o,cols:s}):t.jsx(i,{size:c,rows:o+1,cols:s+1,frontProps:g,backProps:h,frontLayerSx:{pointerEvents:"none"}})}function Me({isGhostMode:e,controlsProps:r,generating:n,onRefresh:o,onOpenInfo:s}){return e?null:t.jsx(w,{...r,onRefresh:o,disabled:n,children:t.jsx(J,{title:"How to Play",Icon:q,onClick:s})})}function De(e,t,r,n){return{grid:Array.from({length:e},()=>new Array(t).fill(0)),numbers:r,solution:n,rows:e,cols:t,solved:!1,errorNodes:new Set,cycleCells:new Set,satisfiedNodes:new Set}}function Ae({getInitialState:t,dispatchRef:r,dimsRef:n,onStaleResult:o}){const[s,i]=e.useState(!1),l=e.useRef(null),c=e.useRef("probing"),a=e.useRef(0),u=e.useRef(0),d=e.useRef(null),f=e.useRef(0),p=e.useRef(o);p.current=o;const h=e.useRef(!1),g=e.useRef(null),x=e.useRef(!1),m=e.useCallback(()=>{if(g.current){const e=g.current;p.current?.(e,e.rows,e.cols)}h.current=!1,g.current=null,x.current=!1},[]),b=e.useCallback((e,n)=>{r.current?.({type:"hydrate",state:t(e,n)}),i(!1)},[r,t]),y=e.useCallback((e,t)=>{m(),i(!0),null!==d.current&&clearTimeout(d.current),cancelAnimationFrame(u.current),d.current=setTimeout(()=>{d.current=null;const r=++a.current;"healthy"===c.current&&l.current?(f.current++,l.current.postMessage({type:"GENERATE",payload:{rows:e,cols:t}})):u.current=requestAnimationFrame(()=>{a.current===r&&b(e,t)})},250)},[b,m]),S=e.useCallback((e,r)=>{h.current||(h.current=!0,g.current=null,x.current=!1,"healthy"===c.current&&l.current?(f.current++,l.current.postMessage({type:"GENERATE",payload:{rows:e,cols:r}})):requestAnimationFrame(()=>{h.current&&(g.current=t(e,r))}))},[t]),v=e.useCallback(()=>{null!==d.current&&(clearTimeout(d.current),d.current=null),cancelAnimationFrame(u.current),m(),i(!1)},[m]),w=e.useCallback(()=>{if(g.current){const e=g.current;return g.current=null,r.current?.({type:"hydrate",state:e}),m(),void i(!1)}if(h.current)return x.current=!0,void i(!0);y(n.current.rows,n.current.cols)},[y,n,r,m]);return e.useEffect(()=>{let e=!1;const t=new Worker(new URL("/assets/generationWorker-BcsDYRLk.js",import.meta.url),{type:"module"});l.current=t;const o=setTimeout(()=>{e||"probing"!==c.current||(c.current="broken",f.current=0,l.current=null,t.terminate())},2e3);return t.onmessage=s=>{if(!e){if("ERROR"===s.data.type)return clearTimeout(o),c.current="broken",f.current=0,l.current=null,void t.terminate();if("RESULT"===s.data.type){if("probing"===c.current)return clearTimeout(o),void(c.current="healthy");f.current--;const{rows:e,cols:t,numbers:l,solution:a}=s.data.payload,u=n.current;if(e!==u.rows||t!==u.cols)return p.current?.(De(e,t,l,a),e,t),void(f.current<=0&&i(!1));if(f.current>0)return;const d=De(e,t,l,a);if(h.current)return g.current=d,void(x.current&&(r.current?.({type:"hydrate",state:d}),h.current=!1,g.current=null,x.current=!1,i(!1)));r.current?.({type:"hydrate",state:d}),i(!1)}}},t.onerror=()=>{clearTimeout(o),c.current="broken",f.current=0,l.current=null,t.terminate()},t.postMessage({type:"GENERATE",payload:{rows:3,cols:3}}),()=>{e=!0,clearTimeout(o),null!==d.current&&clearTimeout(d.current),t.terminate()}},[r,n]),{generating:s,requestGeneration:y,handleNextAsync:w,prefetch:S,cancelGeneration:v}}function ze(e,t,r,n,o,s){const i=e[r];if(!i)return!1;i[n]=o;const l=Re(r,o===ae?n+1:n,s),c=Re(r+1,o===ae?n:n+1,s);return!t.connected(l,c)&&(t.union(l,c),!0)}function Ge(e,t,r){const n=Array.from({length:t},()=>new Array(r).fill(0)),o=new Ee((t+1)*(r+1)),s=function(e,t,r,n,o){let s=!0;for(;s;){s=!1;for(let i=0;i<=r;i++)for(let l=0;l<=n;l++){const c=t[i]?.[l];if(null==c)continue;const a=[{gr:i-1,gc:l-1,pt:ue},{gr:i-1,gc:l,pt:ae},{gr:i,gc:l-1,pt:ae},{gr:i,gc:l,pt:ue}].filter(({gr:e,gc:t})=>e>=0&&e<r&&t>=0&&t<n);let u=0;const d=[];for(const t of a){const r=e[t.gr]?.[t.gc];0===r?d.push(t):r===t.pt&&u++}if(u>c)return"contradiction";if(u+d.length<c)return"contradiction";if(u===c&&d.length>0){for(const{gr:t,gc:r,pt:i}of d)if(0===e[t]?.[r]){if(!ze(e,o,t,r,i===ae?ue:ae,n))return"contradiction";s=!0}}else if(u+d.length===c&&d.length>0)for(const{gr:t,gc:r,pt:i}of d)if(0===e[t]?.[r]){if(!ze(e,o,t,r,i,n))return"contradiction";s=!0}}if(!s){for(let t=0;t<r;t++)for(let r=0;r<n;r++){const i=e[t];if(0!==i?.[r])continue;const l=Re(t,r+1,n),c=Re(t+1,r,n),a=o.connected(l,c),u=Re(t,r,n),d=Re(t+1,r+1,n),f=o.connected(u,d);if(a&&f)return"contradiction";a?(i[r]=ue,s=!0,o.union(u,d)):f&&(i[r]=ae,s=!0,o.union(l,c))}if(!s)for(let i=0;i<r;i++)for(let l=0;l<n;l++){const c=e[i];if(0!==c?.[l])continue;let a=!1,u=!1;const d=[{nr:i,nc:l,touchedBy:ue},{nr:i,nc:l+1,touchedBy:ae},{nr:i+1,nc:l,touchedBy:ae},{nr:i+1,nc:l+1,touchedBy:ue}];for(const{nr:o,nc:s,touchedBy:i}of d){const l=t[o]?.[s];if(null==l)continue;const c=[{gr:o-1,gc:s-1,pt:ue},{gr:o-1,gc:s,pt:ae},{gr:o,gc:s-1,pt:ae},{gr:o,gc:s,pt:ue}].filter(({gr:e,gc:t})=>e>=0&&e<r&&t>=0&&t<n);let d=0,f=0;for(const t of c){const r=e[t.gr]?.[t.gc];0===r?f++:r===t.pt&&d++}i===ae?(d+1>l&&(a=!0),d+(f-1)<l&&(u=!0)):(d+1>l&&(u=!0),d+(f-1)<l&&(a=!0))}if(a&&u)return"contradiction";if(a){if(!ze(e,o,i,l,ue,n))return"contradiction";s=!0}else if(u){if(!ze(e,o,i,l,ae,n))return"contradiction";s=!0}}}}return e.every(e=>e.every(e=>0!==e))?"solved":"stuck"}(n,e,t,r,o);return"contradiction"!==s&&("solved"===s&&function(e,t,r,n){const o=he(e,r,n);for(let s=0;s<=r;s++)for(let e=0;e<=n;e++){const r=t[s]?.[e];if(null!=r&&o[s]?.[e]!==r)return!1}return!0}(n,e,t,r))}function He(e,t){let r=[],n=!1;for(let s=0;s<50&&!n;s++){r=Array.from({length:e},()=>new Array(t).fill(0));const o=new Ee((e+1)*(t+1)),s=[];for(let r=0;r<e;r++)for(let e=0;e<t;e++)s.push({r:r,c:e});for(let e=s.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1)),r=s[e],n=s[t];r&&n&&(s[e]=n,s[t]=r)}let i=!1;for(const{r:e,c:n}of s){const s=Re(e,n+1,t),l=Re(e+1,n,t),c=o.connected(s,l),a=Re(e,n,t),u=Re(e+1,n+1,t),d=o.connected(a,u);if(c&&d){i=!0;break}const f=r[e];f&&(c?(f[n]=ue,o.union(a,u)):d||Math.random()<.5?(f[n]=ae,o.union(s,l)):(f[n]=ue,o.union(a,u)))}i||(n=!0)}n||(r=Array.from({length:e},(e,r)=>new Array(t).fill(r%2==0?ae:ue)));const o=function(e,t,r,n){const o=e.map(e=>[...e]),s=[];for(let c=0;c<=t;c++)for(let e=0;e<=r;e++)s.push({r:c,c:e});for(let c=s.length-1;c>0;c--){const e=Math.floor(Math.random()*(c+1)),t=s[c],r=s[e];t&&r&&(s[c]=r,s[e]=t)}const i=Math.floor((t+1)*(r+1)*n);let l=0;for(let c=0;c<=t;c++)for(let e=0;e<=r;e++)null!==o[c]?.[e]&&l++;for(const{r:c,c:a}of s){if(l<=i)break;const e=o[c];if(!e)continue;const n=e[a];null!=n&&(e[a]=null,Ge(o,t,r)?l--:e[a]=n)}return o}(he(r,e,t).map(e=>e.map(e=>e)),e,t,se);return{numbers:o,solution:r}}const $e=C({getInitialState:Pe,customHandler:(e,t)=>{if("toggle"===t.type){if(e.solved)return e;const{row:r,col:n}=t,o=e.grid.map(e=>[...e]),i=o[r];if(!i)return e;const l=i[n];if(void 0===l)return e;t.reverse?i[n]=0===l?ae:l===ae?ue:0:i[n]=0===l?ue:l===ue?ae:0;let c=!1;if(o.every(e=>e.every(e=>0!==e))){const t=he(o,e.rows,e.cols);e.numbers.every((e,r)=>e.every((e,n)=>null==e||e===t[r]?.[n]))&&!function(e,t,r){const n=new Ee((t+1)*(r+1));for(let o=0;o<t;o++){const t=e[o];if(t)for(let e=0;e<r;e++){const s=t[e];if(void 0===s||0===s)continue;const i=Re(o,s===ae?e+1:e,r),l=Re(o+1,s===ae?e:e+1,r);if(!n.union(i,l))return!0}}return!1}(o,e.rows,e.cols)&&(c=!0)}const a=function(e,t,r,n){const o=new Set,i=he(e,r,n);for(let l=0;l<=r;l++)for(let c=0;c<=n;c++){const a=t[l]?.[c];if(null==a)continue;const u=i[l]?.[c]??0;u>a?o.add(s(l,c)):u+[{gr:l-1,gc:c-1},{gr:l-1,gc:c},{gr:l,gc:c-1},{gr:l,gc:c}].filter(({gr:t,gc:o})=>t>=0&&t<r&&o>=0&&o<n&&0===e[t]?.[o]).length<a&&o.add(s(l,c))}return o}(o,e.numbers,e.rows,e.cols),u=Ie(o,e.rows,e.cols),d=ge(o,e.numbers,e.rows,e.cols);return{...e,grid:o,solved:c,errorNodes:a,cycleCells:u,satisfiedNodes:d}}return e}});function Pe(e,t){const{numbers:r,solution:n}=He(e,t);return{grid:Array.from({length:e},()=>new Array(t).fill(0)),numbers:r,solution:n,rows:k(e),cols:k(t),solved:!1,errorNodes:new Set,cycleCells:new Set,satisfiedNodes:new Set}}function Be(e,t,r){return{position:"absolute",width:"115%",height:`${String(Math.max(2,t))}px`,backgroundColor:r?V.data.red:V.text.primary,borderRadius:"99px",top:"50%",left:"50%",transform:`translate(-50%, -50%) rotate(${e})`,boxShadow:ce.SHADOWS.LINE,transition:K.transition,pointerEvents:"none"}}const Le=(e,r,n)=>(o,i)=>{const l=r.grid[o]?.[i],c=s(o,i),a=r.cycleCells.has(c),u=e(c),d=[{v:r.numbers[o]?.[i],p:s(o,i)},{v:r.numbers[o]?.[i+1],p:s(o,i+1)},{v:r.numbers[o+1]?.[i],p:s(o+1,i)},{v:r.numbers[o+1]?.[i+1],p:s(o+1,i+1)}].map(({v:e,p:t})=>{if(null==e)return"-";const n=r.errorNodes.has(t)?"Error":r.satisfiedNodes.has(t)?"Ok":"Pending";return`${String(e)} (${n})`});return{...u,"aria-label":`Cell ${String(o+1)}, ${String(i+1)}. Clues: ${d.join(", ")}. ${0===l?"Empty":l===ae?"Forward Slash":"Backward Slash"}${a?", Loop Error":""}`,sx:{...u.sx,cursor:"pointer",border:`1px solid ${V.border.subtle}`,position:"relative","&:hover":{backgroundColor:V.interactive.hover}},children:t.jsxs(M,{sx:{width:"100%",height:"100%",position:"relative"},children:[l===ae&&t.jsx(M,{sx:Be("-45deg",n,a)}),l===ue&&t.jsx(M,{sx:Be("45deg",n,a)})]})}};function We(){const r=b("sm"),[n,o]=e.useState(!1),[i,l]=e.useReducer(e=>!e,!1),c=e.useRef(null),a=e.useRef({rows:0,cols:0}),u=e.useCallback((e,t,r)=>{if(n)return;const o=`${oe.STATE}-${String(t)}x${String(r)}`,s={...e,errorNodes:[...e.errorNodes],cycleCells:[...e.cycleCells],satisfiedNodes:[...e.satisfiedNodes]};localStorage.setItem(o,JSON.stringify(s))},[n]),{generating:d,requestGeneration:f,handleNextAsync:p,prefetch:h,cancelGeneration:g}=Ae({getInitialState:Pe,dispatchRef:c,dimsRef:a,onStaleResult:u}),{rows:x,cols:m,state:v,dispatch:w,size:C,controlsProps:k}=j({storageKeys:{size:oe.SIZE,state:oe.STATE},pageTitle:Y.slant,gridConfig:{defaultSize:le,maxSize:ie,paddingOffset:{x:r?48:80,y:120},widthLimit:te,cellSizeReference:4},boardConfig:{paddingOffset:e=>({x:e?48:80,y:ee}),...r?{boardSizeFactor:.92}:{},maxCellSize:re,rowOffset:1,colOffset:1},reducer:$e,getInitialState:(e,t)=>Pe(e,t),manualResize:!0,onNext:p,winAnimationDelay:S.timing.winAnimationDelay,isSolved:e=>e.solved,persistence:{enabled:!n,serialize:e=>({...e,errorNodes:[...e.errorNodes],cycleCells:[...e.cycleCells],satisfiedNodes:[...e.satisfiedNodes]}),deserialize:e=>{const t=e;return{...t,errorNodes:new Set(t.errorNodes),cycleCells:new Set(t.cycleCells),satisfiedNodes:new Set(t.satisfiedNodes)}}}});c.current=w,a.current={rows:x,cols:m};const O=e.useRef(`${String(x)},${String(m)}`);e.useEffect(()=>{const e=`${String(x)},${String(m)}`;if(e!==O.current){if(O.current=e,!n){const e=`${oe.STATE}-${String(x)}x${String(m)}`,t=localStorage.getItem(e);if(t)try{if(!JSON.parse(t).solved)return void g()}catch{}}f(x,m)}},[x,m,f,g,n]),e.useEffect(()=>{v.solved&&!n&&h(x,m)},[v.solved,n,x,m,h]);const[N,D]=e.useState(new Map);E({storageKey:oe.GHOST_MOVES,rows:x,cols:m,state:N,onRestore:e=>{D(e)},serialize:e=>[...e.entries()],deserialize:e=>new Map(e)});const A=e.useRef("");e.useEffect(()=>{const e=JSON.stringify(v.numbers);A.current&&A.current!==e&&D(new Map),A.current=e},[v.numbers,v.rows,v.cols]);const z=p,{getDragProps:G}=y({onToggle:(e,t,r)=>{w({type:"toggle",row:T(e),col:T(t),reverse:r})},checkEnabled:()=>!v.solved,touchTimeout:S.timing.touchHoldDelay}),H=.4*C,$=R(Le,G,[v,C]),P=e.useMemo(()=>((e,r)=>(n,o)=>{const i=e.numbers[n]?.[o],l=s(n,o),c=e.errorNodes.has(l),a=e.satisfiedNodes.has(l);return{sx:{pointerEvents:"none"},children:t.jsx(M,{sx:{borderRadius:"50%",backgroundColor:c?V.data.red:V.surface.background,border:null==i?"none":`2px solid ${c?V.data.red:a?"transparent":V.border.subtle}`,fontSize:`${String(.5*r)}rem`,fontWeight:"800",color:c?ce.COLORS.WHITE:a?V.interactive.disabledText:V.text.primary,boxShadow:a&&!c?"none":ce.SHADOWS.HINT,zIndex:5,opacity:null==i?0:1,display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",userSelect:"none",WebkitUserSelect:"none",transform:c?"scale(1.1)":"scale(1)",width:`${String(r)}rem`,height:`${String(r)}rem`},children:i??""})}})(v,H),[v,H]),B=e.useCallback((e,t)=>{D(r=>{const n=new Map(r);return void 0===t?n.delete(e):n.set(e,t),n})},[]),L=e.useCallback(()=>{const e=new Map;v.grid.forEach((t,r)=>{t.forEach((t,n)=>{0!==t&&e.set(s(r,n),t)})}),D(e)},[v.grid]),W=e.useCallback(()=>{D(new Map)},[]),_=e.useCallback(()=>{o(!1)},[]),U=e.useCallback(e=>{e.stopPropagation()},[]),q=e.useMemo(()=>({px:r?"1rem":"2rem",pt:r?"1rem":"2rem"}),[r]),F=e.useMemo(()=>n?{padding:{xs:0,sm:0}}:void 0,[n]),K=e.useCallback(()=>{l(),o(!0)},[l]),J=t.jsx(Me,{isGhostMode:n,controlsProps:k,generating:d,onRefresh:p,onOpenInfo:l}),X=x!==v.rows||m!==v.cols,Z=t.jsx(Ne,{isGhostMode:n,generating:d,dimensionsMismatch:X,rows:x,cols:m,state:v,size:C,ghostMoves:N,onGhostMove:B,onGhostCopy:L,onGhostClear:W,onGhostClose:_,frontProps:P,backProps:$});return t.jsxs(I,{title:Y.slant,infoUrl:"https://en.wikipedia.org/wiki/Gokigen_Naname",paddingBottom:{xs:"120px",md:"150px"},controls:J,contentSx:q,showTrophy:!n&&v.solved,onReset:z,boardSize:C,iconSizeRatio:ne,boardSx:F,onClick:n?()=>{o(!1)}:void 0,children:[t.jsx(M,{onClick:U,children:Z}),i&&t.jsx(we,{open:i,size:C,toggleOpen:l,onOpenCalculator:K})]})}export{We as default};
